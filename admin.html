<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | CAPITAL Paradox</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{
  background:#050505;
  color:white;
  font-family: 'JetBrains Mono', monospace;
}

.nav{
  background:#050505;
  border-bottom:1px solid #DC2626;
  padding:16px;
  display:flex;
  gap:20px;
  justify-content:space-between;
  align-items:center;
  flex-wrap: wrap;
}

.nav a{ 
  color:white; 
  text-decoration:none;
  transition: color 0.3s;
}

.nav a:hover {
  color: #DC2626;
}

.logout-btn{
  border:1px solid #DC2626;
  padding:6px 14px;
  color:white;
  font-size:12px;
  cursor:pointer;
  transition:.3s;
}

.logout-btn:hover{
  background:#DC2626;
}

.panel{
  border:1px solid #DC2626;
  border-radius:16px;
  padding:24px;
  margin:40px auto;
  max-width:95%;
  background:#050505;
  overflow-x: auto;
}

.admin-table{
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

.admin-table th{
  background:#DC2626;
  padding:12px 8px;
  text-align:center;
  font-size:14px;
  border:1px solid #DC2626;
  font-weight:bold;
  position: sticky;
  top: 0;
  z-index: 10;
}

.admin-table td{
  padding:8px;
  text-align:center;
  border:1px solid #333;
}

.admin-table td:first-child{
  background:#1a1a1a;
  font-weight:bold;
  text-align:left;
  padding-left:16px;
  position: sticky;
  left: 0;
  z-index: 10;
}

.btn{
  border:1px solid #DC2626;
  padding:8px 4px;
  text-align:center;
  cursor:pointer;
  color:white;
  transition:.3s;
  font-size:11px;
  display:block;
  width:100%;
}

.btn:hover{
  background:#DC2626;
}

.state{
  font-size:10px;
  margin-top:4px;
  color:#ff6666;
  text-transform: uppercase;
}

.state.revoked { color: #ef4444; }
.state.access { color: #3b82f6; }
.state.passed { color: #22c55e; }
.state.eliminated { color: #787878; }

.team-input-section{
  margin-bottom:20px;
  padding:16px;
  background:#1a1a1a;
  border-radius:8px;
}

.team-input{
  background:#050505;
  border:1px solid #DC2626;
  color:white;
  padding:8px 12px;
  font-family: 'JetBrains Mono', monospace;
  font-size:12px;
  width:200px;
  margin-right:8px;
}

.team-input:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3);
}

.add-team-btn{
  background:#DC2626;
  border:none;
  color:white;
  padding:8px 16px;
  cursor:pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size:12px;
  transition:.3s;
}

.add-team-btn:hover{
  background:white;
  color:#DC2626;
}

.add-team-btn:disabled {
  background:#444;
  color:#888;
  cursor:not-allowed;
}

.team-list{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}

.team-tag{
  background:#DC2626;
  padding:4px 12px;
  border-radius:4px;
  font-size:11px;
  display:flex;
  align-items:center;
  gap:8px;
}

.budget-table{
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

.budget-table th{
  background:#111;
  color:#DC2626;
  padding:8px;
  text-align:left;
  font-size:12px;
  border:1px solid #333;
}

.budget-table td{
  padding:8px;
  border:1px solid #333;
  font-size:12px;
}

.budget-input{
  background:#050505;
  border:1px solid #DC2626;
  color:white;
  padding:6px 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size:12px;
  width:100%;
}

.budget-toggle{
  transform: scale(1.1);
}

.budget-actions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}

.budget-actions .btn{
  max-width:180px;
}

.remove-team{
  cursor:pointer;
  font-weight:bold;
  opacity: 0.7;
}

.remove-team:hover{
  opacity: 1;
  color:#fff;
}

.loading{
  text-align:center;
  padding:40px;
  color:#DC2626;
}

.loading-spinner {
  border: 3px solid #333;
  border-top: 3px solid #DC2626;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-message {
  background: rgba(220, 38, 38, 0.1);
  border: 1px solid #DC2626;
  color: #DC2626;
  padding: 16px;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
}

@media (max-width: 768px) {
  .panel {
    margin: 20px auto;
    padding: 16px;
  }
  
  .nav {
    flex-direction: column;
    align-items: flex-start;
  }
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(5, 5, 5, 0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-panel {
  background: #0b0b0b;
  border: 1px solid #DC2626;
  padding: 24px;
  width: 90%;
  max-width: 420px;
  text-align: center;
  box-shadow: 0 0 30px rgba(220, 38, 38, 0.2);
}

.modal-actions {
  margin-top: 16px;
  display: flex;
  justify-content: center;
  gap: 12px;
}

.modal-input {
  margin-top: 12px;
}

</style>
</head>

<body>

<nav class="nav" role="navigation" aria-label="Admin navigation">
  <div class="flex gap-6 flex-wrap">
    <a href="index.html">HOME</a>
    <a href="rounds.html">ROUNDS</a>
    <a href="admin-rounds.html">ROUNDS ADMIN</a>
    <a href="rules.html">RULES</a>
    <a href="contact.html">REGISTER</a>
  </div>

  <button class="logout-btn" onclick="logout()" aria-label="Log out from admin panel">LOG OUT</button>
</nav>

  <div class="panel">
  <h1 style="color:#DC2626;font-size:22px;margin-bottom:12px;">
  ADMIN CONTROL PANEL
  </h1>

<div id="loading" class="loading">
  <div class="loading-spinner"></div>
  <p>Loading Firebase data...</p>
</div>

<div id="error-display" class="error-message" style="display: none;">
  <p id="error-text"></p>
  <button onclick="window.location.reload()" class="add-team-btn mt-4">RETRY</button>
</div>

<div id="admin-content" style="display:none;">
  <!-- Auction Control Section -->
  <div class="team-input-section" id="auction-control-section">
    <div style="color:#DC2626;font-size:12px;font-weight:bold;margin-bottom:8px;">
      AUCTION CONTROL
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
      <div>
        <p class="text-gray-400 text-xs">Auction status</p>
        <p id="auction-status-label" class="text-white text-sm">LOADING...</p>
      </div>
      <div>
        <button class="add-team-btn" onclick="openAuction()" id="auction-open-btn">OPEN AUCTION</button>
      </div>
      <div>
        <button class="btn" onclick="closeAuction()" id="auction-close-btn">CLOSE AUCTION</button>
      </div>
    </div>
  </div>

  <!-- Auction Budget Settings -->
  <div class="team-input-section" id="budget-section">
    <div style="color:#DC2626;font-size:12px;font-weight:bold;margin-bottom:8px;">
      AUCTION SETTINGS (ACTUAL VALUES)
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;">
      <div style="min-width:220px;flex:1;">
        <label for="auction-search" style="color:#DC2626;font-size:11px;display:block;margin-bottom:6px;">
          SEARCH ITEMS
        </label>
        <input 
          type="text"
          id="auction-search"
          class="budget-input"
          placeholder="Search by item name or number">
      </div>
      <div style="min-width:180px;">
        <label for="auction-category" style="color:#DC2626;font-size:11px;display:block;margin-bottom:6px;">
          CATEGORY FILTER
        </label>
        <select id="auction-category" class="budget-input">
          <option value="all">ALL</option>
          <option value="Antiques">ANTIQUES</option>
          <option value="Stocks">STOCKS</option>
          <option value="Goods">GOODS</option>
        </select>
      </div>
      <div style="min-width:200px;">
        <label for="auction-winner-bulk" style="color:#DC2626;font-size:11px;display:block;margin-bottom:6px;">
          BULK WINNER (NEXT DISPLAYED)
        </label>
        <input id="auction-winner-bulk" class="budget-input" list="team-options" placeholder="Search team..." />
      </div>
      <div style="min-width:120px;">
        <label for="auction-winner-count" style="color:#DC2626;font-size:11px;display:block;margin-bottom:6px;">
          COUNT
        </label>
        <input id="auction-winner-count" type="number" min="1" step="1" value="1" class="budget-input" />
      </div>
      <div style="min-width:160px;margin-top:18px;">
        <button class="btn" onclick="assignWinnerNext()">ASSIGN WINNER</button>
      </div>
      <div style="min-width:160px;display:flex;align-items:center;gap:8px;margin-top:18px;">
        <input type="checkbox" id="auction-display-only" class="budget-toggle" />
        <label for="auction-display-only" style="color:#DC2626;font-size:11px;">DISPLAYED ONLY</label>
      </div>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
      <div style="min-width:220px;flex:1;">
        <label for="budget-total-input" style="color:#DC2626;font-size:11px;display:block;margin-bottom:6px;">
          TOTAL CAPITAL
        </label>
        <input 
          type="number"
          id="budget-total-input"
          class="budget-input"
          min="0"
          step="1"
          aria-label="Total capital for round one">
      </div>
    </div>

    <div style="margin-top:16px;">
      <div style="color:#DC2626;font-size:11px;margin-bottom:6px;">
        ITEM LIST (VISIBLE TO TEAMS)
      </div>
      <div id="budget-items-container"></div>
      <datalist id="team-options"></datalist>
      <div class="budget-actions">
        <button class="add-team-btn" onclick="addBudgetItem()">+ ADD ITEM</button>
        <button class="btn" onclick="revealAllItems()">REVEAL ALL ACTUALS</button>
        <button class="btn" onclick="hideAllItems()">HIDE ALL ACTUALS</button>
        <button class="btn" onclick="displayNextItem()">DISPLAY NEXT</button>
        <button class="btn" onclick="revealNextItem()">REVEAL NEXT</button>
        <button class="btn" onclick="hideAllDisplayedItems()">HIDE ALL ITEMS</button>
      </div>
      <p class="text-gray-400 text-xs mt-2">Changes save automatically.</p>
    </div>
  </div>
</div>
</div>

<!-- Load Firebase Config -->
<script src="firebase-config.js"></script>

<script>
// ==========================================
// MODAL HELPERS
// ==========================================

function showModal(message) {
  return new Promise((resolve) => {
    const modal = document.getElementById("admin-modal");
    const msg = document.getElementById("admin-modal-message");
    const input = document.getElementById("admin-modal-input");
    const ok = document.getElementById("admin-modal-ok");
    const cancel = document.getElementById("admin-modal-cancel");

    msg.textContent = message;
    input.style.display = "none";
    cancel.style.display = "none";
    modal.style.display = "flex";

    const cleanup = () => {
      modal.style.display = "none";
      ok.removeEventListener("click", onOk);
      cancel.removeEventListener("click", onCancel);
    };

    const onOk = () => {
      cleanup();
      resolve(true);
    };

    const onCancel = () => {
      cleanup();
      resolve(false);
    };

    ok.addEventListener("click", onOk);
    cancel.addEventListener("click", onCancel);
  });
}

function confirmAction(message) {
  return new Promise((resolve) => {
    const modal = document.getElementById("admin-modal");
    const msg = document.getElementById("admin-modal-message");
    const input = document.getElementById("admin-modal-input");
    const ok = document.getElementById("admin-modal-ok");
    const cancel = document.getElementById("admin-modal-cancel");

    msg.textContent = message;
    input.style.display = "none";
    cancel.style.display = "inline-block";
    modal.style.display = "flex";

    const cleanup = () => {
      modal.style.display = "none";
      ok.removeEventListener("click", onOk);
      cancel.removeEventListener("click", onCancel);
    };

    const onOk = () => {
      cleanup();
      resolve(true);
    };

    const onCancel = () => {
      cleanup();
      resolve(false);
    };

    ok.addEventListener("click", onOk);
    cancel.addEventListener("click", onCancel);
  });
}

function requestPassword() {
  return new Promise((resolve) => {
    const modal = document.getElementById("admin-modal");
    const msg = document.getElementById("admin-modal-message");
    const input = document.getElementById("admin-modal-input");
    const ok = document.getElementById("admin-modal-ok");
    const cancel = document.getElementById("admin-modal-cancel");

    msg.textContent = "Enter admin password:";
    input.value = "";
    input.style.display = "block";
    cancel.style.display = "inline-block";
    modal.style.display = "flex";
    input.focus();

    const cleanup = () => {
      modal.style.display = "none";
      ok.removeEventListener("click", onOk);
      cancel.removeEventListener("click", onCancel);
    };

    const onOk = () => {
      const val = input.value.trim();
      cleanup();
      resolve(val || null);
    };

    const onCancel = () => {
      cleanup();
      resolve(null);
    };

    ok.addEventListener("click", onOk);
    cancel.addEventListener("click", onCancel);
  });
}

// ==========================================
// ADMIN ACCESS CHECK - IMPROVED SECURITY
// ==========================================

const ADMIN_SESSION_KEY = "capital_admin_session";

// Check if admin is logged in
async function checkAdminAuth() {
  if(sessionStorage.getItem(ADMIN_SESSION_KEY) !== "true"){
    // Prompt for password
    const password = await requestPassword();
    
    if (!password) {
      await showModal("Unauthorized access. Redirecting...");
      window.location.href = "rounds.html";
      return false;
    }
    
    try {
      const isValid = await validateAdminAccess(password);
      if (!isValid) {
        await showModal("Invalid password. Redirecting...");
        window.location.href = "rounds.html";
        return false;
      }
      sessionStorage.setItem(ADMIN_SESSION_KEY, "true");
      return true;
    } catch (e) {
      await showModal("Authentication error. Redirecting...");
      window.location.href = "rounds.html";
      return false;
    }
  }
  return true;
}

const STATES = ["revoked","access","passed","eliminated"];
const AUCTION_CONFIG_PATH = "auctionConfig";
const AUCTION_ITEMS_PATH = "auctionItems";
const AUCTION_STATUS_PATH = "auctionStatus";
const AUCTION_BIDS_PATH = "auctionBids";
let budgetState = { totalCapital: 100000 };
let auctionItemsState = {};
let budgetSaveTimer = null;
let teamListCache = [];
let auctionFilterState = {
  search: "",
  category: "all",
  displayedOnly: false
};

// ==========================================
// FIREBASE DATABASE FUNCTIONS
// ==========================================

function showError(message) {
  document.getElementById("error-text").innerText = message;
  document.getElementById("error-display").style.display = "block";
  document.getElementById("loading").style.display = "none";
  document.getElementById("admin-content").style.display = "none";
}

function getTeamList(callback){
  if (!database) {
    showError("Firebase not initialized. Check your firebase-config.js");
    return;
  }
  
  database.ref('teamList').once('value').then((snapshot) => {
    const teams = snapshot.val() || ["ALPHA", "BETA", "GAMMA"];
    callback(teams);
  }).catch((error) => {
    console.error("Error fetching team list:", error);
    showError("Failed to load team list. Check your connection.");
  });
}

function setTeamList(teams){
  if (!database) return;
  database.ref('teamList').set(teams).catch((error) => {
    console.error("Error saving team list:", error);
    showModal("Failed to save team list. Please try again.");
  });
}

function getTeamStates(callback){
  if (!database) {
    showError("Firebase not initialized.");
    return;
  }
  
  database.ref('teamStates').once('value').then((snapshot) => {
    const states = snapshot.val() || {};
    callback(states);
  }).catch((error) => {
    console.error("Error fetching team states:", error);
    showError("Failed to load team states. Check your connection.");
  });
}

function openAuction() {
  if (!database) return;
  database.ref(AUCTION_STATUS_PATH).set("open").catch((error) => {
    console.error("Error opening auction:", error);
    showModal("Failed to open auction.");
  });
}

function closeAuction() {
  if (!database) return;
  database.ref(AUCTION_STATUS_PATH).set("closed").catch((error) => {
    console.error("Error closing auction:", error);
    showModal("Failed to close auction.");
  });
}

function listenAuctionStatus() {
  if (!database) return;
  database.ref(AUCTION_STATUS_PATH).on("value", (snapshot) => {
    const raw = snapshot.val();
    const status = raw || "closed";
    const label = document.getElementById("auction-status-label");
    const openBtn = document.getElementById("auction-open-btn");
    const closeBtn = document.getElementById("auction-close-btn");
    if (label) label.textContent = status.toUpperCase();
    if (openBtn) openBtn.disabled = status === "open";
    if (closeBtn) closeBtn.disabled = status === "closed";
    if (!raw) {
      database.ref(AUCTION_STATUS_PATH).set("closed");
    }
  });
}

// ==========================================
// AUCTION BUDGET CONFIGURATION
// ==========================================

const DEFAULT_AUCTION_ITEMS = [
  { number: 1, category: "Antiques", name: "Ming Dynasty Vase", actualValue: 14000 },
  { number: 2, category: "Antiques", name: "Samurai Sword", actualValue: 16000 },
  { number: 3, category: "Antiques", name: "Royal Crown Replica", actualValue: 15000 },
  { number: 4, category: "Antiques", name: "Pharaoh Statue", actualValue: 14500 },
  { number: 5, category: "Antiques", name: "Historical Dossier", actualValue: 16500 },
  { number: 6, category: "Antiques", name: "Vintage Typewriter", actualValue: 8000 },
  { number: 7, category: "Antiques", name: "Victorian Pocket Watch", actualValue: 9000 },
  { number: 8, category: "Antiques", name: "Ancient Scroll Replica", actualValue: 7000 },
  { number: 9, category: "Antiques", name: "Gramophone", actualValue: 8500 },
  { number: 10, category: "Antiques", name: "Brass Telescope", actualValue: 7500 },
  { number: 11, category: "Antiques", name: "Roman Bronze Coin", actualValue: 6000 },
  { number: 12, category: "Antiques", name: "Old Globe Map", actualValue: 11000 },
  { number: 13, category: "Antiques", name: "Medieval Shield", actualValue: 12000 },
  { number: 14, category: "Antiques", name: "Buddha Sculpture", actualValue: 13000 },
  { number: 15, category: "Antiques", name: "Gandhi Glasses", actualValue: 18000 },
  { number: 16, category: "Stocks", name: "Titanic Shipping", actualValue: 17000 },
  { number: 17, category: "Stocks", name: "Vintage Rail Bonds", actualValue: 14000 },
  { number: 18, category: "Stocks", name: "Dot-Com Stock", actualValue: 16000 },
  { number: 19, category: "Stocks", name: "Old Coal Co.", actualValue: 13500 },
  { number: 20, category: "Stocks", name: "Government Bond", actualValue: 10000 },
  { number: 21, category: "Stocks", name: "Blue-Chip Reliant", actualValue: 13000 },
  { number: 22, category: "Stocks", name: "Traditional Bank", actualValue: 12500 },
  { number: 23, category: "Stocks", name: "FMCG Stock", actualValue: 11500 },
  { number: 24, category: "Stocks", name: "Green Energy", actualValue: 15000 },
  { number: 25, category: "Stocks", name: "AI Tech", actualValue: 17500 },
  { number: 26, category: "Stocks", name: "Space Startup", actualValue: 19000 },
  { number: 27, category: "Stocks", name: "Crypto NeoCoin", actualValue: 18000 },
  { number: 28, category: "Goods", name: "Luxury Wine", actualValue: 14000 },
  { number: 29, category: "Goods", name: "Antique Furniture", actualValue: 13500 },
  { number: 30, category: "Goods", name: "Vintage Car Model", actualValue: 15000 },
  { number: 31, category: "Goods", name: "Ornamental Sword", actualValue: 12000 },
  { number: 32, category: "Goods", name: "Silk Bundle", actualValue: 9500 },
  { number: 33, category: "Goods", name: "Ancient Spices", actualValue: 8500 },
  { number: 34, category: "Goods", name: "Copper Bars", actualValue: 10000 },
  { number: 35, category: "Goods", name: "Artisan Pottery", actualValue: 7500 },
  { number: 36, category: "Goods", name: "Gold Bar", actualValue: 18500 },
  { number: 37, category: "Goods", name: "Rare Gemstones", actualValue: 17000 },
  { number: 38, category: "Goods", name: "Silver Bullion", actualValue: 14500 },
  { number: 39, category: "Goods", name: "Energy Battery", actualValue: 16000 },
  { number: 40, category: "Goods", name: "Premium Artwork", actualValue: 15500 }
];

function normalizeBudgetState(data) {
  const raw = data || {};
  const totalCapital = Number(raw.totalCapital);
  return {
    totalCapital: Number.isFinite(totalCapital) ? totalCapital : 100000
  };
}

function normalizeAuctionItems(data) {
  const raw = data || {};
  const items = {};

  Object.keys(raw).forEach((id) => {
    const item = raw[id] || {};
    items[id] = {
      number: Number(item.number) || 0,
      category: typeof item.category === "string" ? item.category : "Antiques",
      name: typeof item.name === "string" ? item.name : "Unnamed Item",
      actualValue: Number(item.actualValue) || 0,
      display: item.display !== false,
      reveal: item.reveal === true,
      winnerTeam: typeof item.winnerTeam === "string" ? item.winnerTeam : "",
      displayedAt: Number(item.displayedAt) || 0
    };
  });

  return items;
}

function scheduleBudgetSave() {
  if (!database) return;
  clearTimeout(budgetSaveTimer);
  budgetSaveTimer = setTimeout(() => {
    Promise.all([
      database.ref(AUCTION_CONFIG_PATH).set(budgetState),
      database.ref(AUCTION_ITEMS_PATH).set(auctionItemsState)
    ]).catch((error) => {
      console.error("Error saving auction config:", error);
      showModal("Failed to save auction settings. Please try again.");
    });
  }, 400);
}

function renderBudgetSection() {
  const totalInput = document.getElementById("budget-total-input");
  const container = document.getElementById("budget-items-container");
  const searchInput = document.getElementById("auction-search");
  const categorySelect = document.getElementById("auction-category");
  const displayOnlyToggle = document.getElementById("auction-display-only");
  const bulkWinnerSelect = document.getElementById("auction-winner-bulk");
  const bulkWinnerCount = document.getElementById("auction-winner-count");
  if (!totalInput || !container) return;

  totalInput.value = budgetState.totalCapital;
  if (searchInput) searchInput.value = auctionFilterState.search;
  if (categorySelect) categorySelect.value = auctionFilterState.category;
  if (displayOnlyToggle) displayOnlyToggle.checked = auctionFilterState.displayedOnly;
  const datalist = document.getElementById("team-options");
  if (datalist) {
    datalist.innerHTML = teamListCache.map(team => `<option value="${team}"></option>`).join("");
  }
  if (bulkWinnerCount && !bulkWinnerCount.value) {
    bulkWinnerCount.value = "1";
  }

  const itemIds = Object.keys(auctionItemsState).sort((a, b) => {
    const aNum = auctionItemsState[a].number || 0;
    const bNum = auctionItemsState[b].number || 0;
    return aNum - bNum;
  });
  const filteredIds = itemIds.filter((id) => {
    const item = auctionItemsState[id];
    if (!item) return false;
    const search = auctionFilterState.search.trim().toLowerCase();
    const matchesSearch = !search ||
      item.name.toLowerCase().includes(search) ||
      String(item.number).includes(search);
    const matchesCategory = auctionFilterState.category === "all" || item.category === auctionFilterState.category;
    const matchesDisplay = !auctionFilterState.displayedOnly || item.display === true;
    return matchesSearch && matchesCategory && matchesDisplay;
  });

  if (filteredIds.length === 0) {
    container.innerHTML = `<div class="text-gray-400 text-xs">No items added yet.</div>`;
  } else {
    const rows = filteredIds.map((id) => {
      const item = auctionItemsState[id];
      const winnerValue = item.winnerTeam ? item.winnerTeam : "";
      return `
        <tr>
          <td>
            <button class="btn" data-budget-display="${id}">${item.display ? "DISPLAYED" : "HIDDEN"}</button>
          </td>
          <td>
            <input type="text" class="budget-input" data-budget-category="${id}" value="${item.category.replace(/"/g, '&quot;')}" aria-label="Item category">
          </td>
          <td>
            <input type="text" class="budget-input" data-budget-name="${id}" value="${item.name.replace(/"/g, '&quot;')}" aria-label="Item name">
          </td>
          <td>
            <input type="number" class="budget-input" data-budget-actual="${id}" value="${item.actualValue}" min="0" step="1" aria-label="Actual value">
          </td>
          <td>
            <input class="budget-input" data-budget-winner="${id}" value="${winnerValue.replace(/"/g, '&quot;')}" list="team-options" placeholder="Search team..." aria-label="Winning team">
          </td>
          <td>
            <input type="checkbox" class="budget-toggle" data-budget-reveal="${id}" ${item.reveal ? "checked" : ""} aria-label="Reveal actual value for ${item.name}">
          </td>
          <td>
            <button class="btn" data-budget-reset="${id}" aria-label="Reset bids for ${item.name}">RESET BIDS</button>
          </td>
          <td>
            <button class="btn" data-budget-remove="${id}" aria-label="Remove item ${item.name}">REMOVE</button>
          </td>
        </tr>
      `;
    }).join("");

    container.innerHTML = `
      <table class="budget-table">
        <thead>
          <tr>
            <th>DISPLAY</th>
            <th>CATEGORY</th>
            <th>ITEM NAME</th>
            <th>ACTUAL VALUE</th>
            <th>WINNER</th>
            <th>REVEAL</th>
            <th>RESET</th>
            <th>REMOVE</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    `;
  }

  totalInput.oninput = () => {
    const val = Number(totalInput.value);
    budgetState.totalCapital = Number.isFinite(val) ? val : 0;
    scheduleBudgetSave();
  };

  if (searchInput) {
    searchInput.oninput = () => {
      auctionFilterState.search = searchInput.value || "";
      renderBudgetSection();
    };
  }

  if (categorySelect) {
    categorySelect.onchange = () => {
      auctionFilterState.category = categorySelect.value || "all";
      renderBudgetSection();
    };
  }

  if (displayOnlyToggle) {
    displayOnlyToggle.onchange = () => {
      auctionFilterState.displayedOnly = displayOnlyToggle.checked;
      renderBudgetSection();
    };
  }

  container.querySelectorAll("[data-budget-name]").forEach((input) => {
    input.addEventListener("input", () => {
      const id = input.getAttribute("data-budget-name");
      if (!auctionItemsState[id]) return;
      auctionItemsState[id].name = input.value.trim() || "Unnamed Item";
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-category]").forEach((input) => {
    input.addEventListener("input", () => {
      const id = input.getAttribute("data-budget-category");
      if (!auctionItemsState[id]) return;
      auctionItemsState[id].category = input.value.trim() || "Antiques";
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-actual]").forEach((input) => {
    input.addEventListener("input", () => {
      const id = input.getAttribute("data-budget-actual");
      if (!auctionItemsState[id]) return;
      const val = Number(input.value);
      auctionItemsState[id].actualValue = Number.isFinite(val) ? val : 0;
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-display]").forEach((button) => {
    button.addEventListener("click", () => {
      const id = button.getAttribute("data-budget-display");
      if (!auctionItemsState[id]) return;
      const nextDisplay = !auctionItemsState[id].display;
      auctionItemsState[id].display = nextDisplay;
      if (nextDisplay) {
        auctionItemsState[id].displayedAt = Date.now();
      }
      renderBudgetSection();
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-winner]").forEach((input) => {
    const id = input.getAttribute("data-budget-winner");
    if (auctionItemsState[id]) {
      input.value = auctionItemsState[id].winnerTeam || "";
      input.dataset.prev = auctionItemsState[id].winnerTeam || "";
    }
    input.addEventListener("change", () => {
      if (!auctionItemsState[id]) return;
      const value = (input.value || "").trim().toUpperCase();
      if (!value) {
        auctionItemsState[id].winnerTeam = "";
        input.dataset.prev = "";
        scheduleBudgetSave();
        return;
      }
      if (!teamListCache.includes(value)) {
        showModal("Team not found. Please select a valid team.");
        input.value = input.dataset.prev || "";
        return;
      }
      auctionItemsState[id].winnerTeam = value;
      input.dataset.prev = value;
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-reveal]").forEach((input) => {
    input.addEventListener("change", () => {
      const id = input.getAttribute("data-budget-reveal");
      if (!auctionItemsState[id]) return;
      auctionItemsState[id].reveal = input.checked;
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-remove]").forEach((button) => {
    button.addEventListener("click", () => {
      const id = button.getAttribute("data-budget-remove");
      if (!auctionItemsState[id]) return;
      delete auctionItemsState[id];
      renderBudgetSection();
      scheduleBudgetSave();
    });
  });

  container.querySelectorAll("[data-budget-reset]").forEach((button) => {
    button.addEventListener("click", async () => {
      const id = button.getAttribute("data-budget-reset");
      if (!id) return;
      const ok = await confirmAction("Reset all bids for this item?");
      if (!ok) return;
      if (!database) return;
      const updates = {};
      teamListCache.forEach((team) => {
        updates[`${AUCTION_BIDS_PATH}/${team}/${id}`] = null;
      });
      database.ref().update(updates).catch((error) => {
        console.error("Error resetting bids:", error);
        showModal("Failed to reset bids.");
      });
    });
  });
}

function loadAuctionConfig() {
  if (!database) return;
  Promise.all([
    database.ref(AUCTION_CONFIG_PATH).once("value"),
    database.ref(AUCTION_ITEMS_PATH).once("value")
  ]).then(([configSnap, itemsSnap]) => {
    budgetState = normalizeBudgetState(configSnap.val());
    auctionItemsState = normalizeAuctionItems(itemsSnap.val());

    if (!itemsSnap.exists() || Object.keys(auctionItemsState).length === 0) {
      auctionItemsState = {};
      DEFAULT_AUCTION_ITEMS.forEach((item) => {
        const id = `item_${item.number}`;
        auctionItemsState[id] = {
          number: item.number,
          category: item.category,
          name: item.name,
          actualValue: item.actualValue,
          display: true,
          reveal: false,
          winnerTeam: "",
          displayedAt: Date.now()
        };
      });
    }

    renderBudgetSection();

    if (!configSnap.exists() || !itemsSnap.exists()) {
      scheduleBudgetSave();
    }
  }).catch((error) => {
    console.error("Error loading auction config:", error);
    showModal("Failed to load auction settings. Please refresh.");
  });
}

function addBudgetItem() {
  const maxNumber = Object.values(auctionItemsState).reduce((max, item) => Math.max(max, item.number || 0), 0);
  const number = maxNumber + 1;
  const id = `item_${number}_${Date.now()}`;
  auctionItemsState[id] = {
    number,
    category: "Antiques",
    name: "New Item",
    actualValue: 0,
    display: true,
    reveal: false
  };
  renderBudgetSection();
  scheduleBudgetSave();
}

function revealAllItems() {
  Object.keys(auctionItemsState).forEach((id) => {
    auctionItemsState[id].reveal = true;
  });
  renderBudgetSection();
  scheduleBudgetSave();
}

function hideAllItems() {
  Object.keys(auctionItemsState).forEach((id) => {
    auctionItemsState[id].reveal = false;
  });
  renderBudgetSection();
  scheduleBudgetSave();
}

function hideAllDisplayedItems() {
  Object.keys(auctionItemsState).forEach((id) => {
    auctionItemsState[id].display = false;
    auctionItemsState[id].displayedAt = 0;
  });
  renderBudgetSection();
  scheduleBudgetSave();
}

function displayNextItem() {
  const nextId = Object.keys(auctionItemsState)
    .sort((a, b) => (auctionItemsState[a].number || 0) - (auctionItemsState[b].number || 0))
    .find((id) => auctionItemsState[id] && auctionItemsState[id].display === false);
  if (!nextId) {
    showModal("All items are already displayed.");
    return;
  }
  auctionItemsState[nextId].display = true;
  auctionItemsState[nextId].displayedAt = Date.now();
  renderBudgetSection();
  scheduleBudgetSave();
}

function revealNextItem() {
  const nextId = Object.keys(auctionItemsState)
    .sort((a, b) => (auctionItemsState[a].number || 0) - (auctionItemsState[b].number || 0))
    .find((id) => {
      const item = auctionItemsState[id];
      return item && item.display === true && item.reveal === false;
    });
  if (!nextId) {
    showModal("No displayed items left to reveal.");
    return;
  }
  auctionItemsState[nextId].reveal = true;
  renderBudgetSection();
  scheduleBudgetSave();
}

function assignWinnerNext() {
  const select = document.getElementById("auction-winner-bulk");
  const countInput = document.getElementById("auction-winner-count");
  if (!select || !countInput) return;
  const winner = (select.value || "").trim().toUpperCase();
  const count = Math.max(1, Number(countInput.value) || 1);
  if (!winner) {
    showModal("Select a winner first.");
    return;
  }
  if (!teamListCache.includes(winner)) {
    showModal("Team not found. Please select a valid team.");
    return;
  }
  const ids = Object.keys(auctionItemsState)
    .sort((a, b) => (auctionItemsState[a].number || 0) - (auctionItemsState[b].number || 0))
    .filter((id) => {
      const item = auctionItemsState[id];
      return item && item.display === true && !item.winnerTeam;
    })
    .slice(0, count);

  if (ids.length === 0) {
    showModal("No displayed items without winners.");
    return;
  }

  ids.forEach((id) => {
    auctionItemsState[id].winnerTeam = winner;
  });
  renderBudgetSection();
  scheduleBudgetSave();
}

function initializeStates(){
  getTeamList((teams) => {
    getTeamStates((states) => {
      let updated = false;
      
      // Ensure all rounds exist
      for(let r=1; r<=4; r++){
        if(!states[r]) {
          states[r] = {};
          updated = true;
        }
        
        // Ensure all teams exist in each round
        teams.forEach(team => {
          if(!states[r][team]) {
            states[r][team] = "revoked";
            updated = true;
          }
        });
      }
      
      if(updated){
        database.ref('teamStates').set(states).then(() => {
          render();
        }).catch((error) => {
          console.error("Error initializing states:", error);
          showError("Failed to initialize team states.");
        });
      } else {
        render();
      }
    });
  });
}

// ==========================================
// RENDER
// ==========================================

function render(){
  getTeamList((teams) => {
    teamListCache = teams || [];

    document.getElementById("loading").style.display = "none";
    document.getElementById("error-display").style.display = "none";
    document.getElementById("admin-content").style.display = "block";

    renderBudgetSection();
  });
}

function logout(){
  sessionStorage.removeItem(ADMIN_SESSION_KEY);
  window.location.href = "rounds.html";
}

// ==========================================
// INITIALIZE
// ==========================================

async function initialize() {
  // Check authentication first
  const isAuthorized = await checkAdminAuth();
  if (!isAuthorized) return;
  
  // Check if Firebase is initialized
  if (!database) {
    showError("Firebase not initialized. Please check your firebase-config.js file.");
    return;
  }

  listenAuctionStatus();
  loadAuctionConfig();
  
  // Ensure team list exists
  getTeamList((teams) => {
    if(teams.length === 0 || !teams){
      setTeamList(["ALPHA", "BETA", "GAMMA"]);
    }
    render();
  });
}

// Start initialization when page loads
window.addEventListener("load", initialize);
</script>

<!-- Admin Modal -->
<div id="admin-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="admin-modal-title">
  <div class="modal-panel">
    <h3 id="admin-modal-title" style="color:#DC2626;font-size:18px;margin-bottom:8px;">NOTICE</h3>
    <p id="admin-modal-message" style="color:#cfcfcf;font-size:13px;"></p>
    <input id="admin-modal-input" type="password" class="team-input modal-input" placeholder="Enter admin password" style="width:100%;display:none;" />
    <div class="modal-actions">
      <button id="admin-modal-cancel" class="btn" style="max-width:120px;">CANCEL</button>
      <button id="admin-modal-ok" class="btn" style="max-width:120px;">OK</button>
    </div>
  </div>
</div>

</body>
</html>
