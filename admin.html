<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | CAPITAL Paradox</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{
  background:#050505;
  color:white;
  font-family: JetBrains Mono;
}

.nav{
  background:#050505;
  border-bottom:1px solid #DC2626;
  padding:16px;
  display:flex;
  gap:20px;
  justify-content:space-between;
  align-items:center;
}

.nav a{ color:white; text-decoration:none; }

.logout-btn{
  border:1px solid #DC2626;
  padding:6px 14px;
  color:white;
  font-size:12px;
  cursor:pointer;
  transition:.3s;
}

.logout-btn:hover{
  background:#DC2626;
}

.panel{
  border:1px solid #DC2626;
  border-radius:16px;
  padding:24px;
  margin:40px auto;
  max-width:95%;
  background:#050505;
  overflow-x: auto;
}

.admin-table{
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

.admin-table th{
  background:#DC2626;
  padding:12px 8px;
  text-align:center;
  font-size:14px;
  border:1px solid #DC2626;
  font-weight:bold;
}

.admin-table td{
  padding:8px;
  text-align:center;
  border:1px solid #333;
}

.admin-table td:first-child{
  background:#1a1a1a;
  font-weight:bold;
  text-align:left;
  padding-left:16px;
  position: sticky;
  left: 0;
  z-index: 10;
}

.btn{
  border:1px solid #DC2626;
  padding:8px 4px;
  text-align:center;
  cursor:pointer;
  color:white;
  transition:.3s;
  font-size:11px;
  display:block;
  width:100%;
}

.btn:hover{
  background:#DC2626;
}

.state{
  font-size:10px;
  margin-top:4px;
  color:#ff6666;
}

.team-input-section{
  margin-bottom:20px;
  padding:16px;
  background:#1a1a1a;
  border-radius:8px;
}

.team-input{
  background:#050505;
  border:1px solid #DC2626;
  color:white;
  padding:8px 12px;
  font-family: JetBrains Mono;
  font-size:12px;
  width:200px;
  margin-right:8px;
}

.add-team-btn{
  background:#DC2626;
  border:none;
  color:white;
  padding:8px 16px;
  cursor:pointer;
  font-family: JetBrains Mono;
  font-size:12px;
  transition:.3s;
}

.add-team-btn:hover{
  background:white;
  color:#DC2626;
}

.team-list{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}

.team-tag{
  background:#DC2626;
  padding:4px 12px;
  border-radius:4px;
  font-size:11px;
  display:flex;
  align-items:center;
  gap:8px;
}

.remove-team{
  cursor:pointer;
  font-weight:bold;
}

.remove-team:hover{
  color:#fff;
}

.loading{
  text-align:center;
  padding:40px;
  color:#DC2626;
}
</style>
</head>

<body>

<nav class="nav">
  <div class="flex gap-6">
    <a href="index.html">HOME</a>
    <a href="rounds.html">ROUNDS</a>
    <a href="rules.html">RULES</a>
    <a href="contact.html">REGISTER</a>
  </div>

  <button class="logout-btn" onclick="logout()">LOG OUT</button>
</nav>

<div class="panel">
<h2 style="color:#DC2626;font-size:22px;margin-bottom:12px;">
ADMIN CONTROL PANEL
</h2>

<p class="text-gray-400 mb-4 text-sm">
Click each cell to cycle through: REVOKED → ACCESS → PASSED → ELIMINATED
</p>

<div id="loading" class="loading">
  <p>Loading Firebase data...</p>
</div>

<div id="admin-content" style="display:none;">
  <!-- Team Management Section -->
  <div class="team-input-section">
    <div style="margin-bottom:8px;">
      <label style="color:#DC2626;font-size:12px;font-weight:bold;">ADD TEAM:</label>
    </div>
    <input type="text" id="new-team-input" class="team-input" placeholder="Enter team name (e.g., TEAM_A)" maxlength="20">
    <button class="add-team-btn" onclick="addTeam()">+ ADD TEAM</button>
    
    <div class="team-list" id="team-list"></div>
  </div>

  <!-- Admin Grid -->
  <div style="overflow-x:auto;">
    <table class="admin-table" id="admin-grid">
      <thead>
        <tr>
          <th>TEAM</th>
          <th>ROUND 1</th>
          <th>ROUND 2</th>
          <th>ROUND 3</th>
          <th>ROUND 4</th>
        </tr>
      </thead>
      <tbody id="grid-body">
      </tbody>
    </table>
  </div>
</div>
</div>

<!-- Load Firebase Config -->
<script src="firebase-config.js"></script>

<script>
// ==========================================
// ADMIN ACCESS CHECK
// ==========================================

const ADMIN_SESSION_KEY = "capital_admin_session";

// Check if admin is logged in
if(sessionStorage.getItem(ADMIN_SESSION_KEY) !== "true"){
    alert("Unauthorized access. Redirecting...");
    window.location.href = "rounds.html";
}

const STATES = ["revoked","access","passed","eliminated"];

// ==========================================
// FIREBASE DATABASE FUNCTIONS
// ==========================================

function getTeamList(callback){
    database.ref('teamList').once('value', (snapshot) => {
        const teams = snapshot.val() || ["ALPHA", "BETA", "GAMMA"];
        callback(teams);
    });
}

function setTeamList(teams){
    database.ref('teamList').set(teams);
}

function getTeamStates(callback){
    database.ref('teamStates').once('value', (snapshot) => {
        const states = snapshot.val() || {};
        callback(states);
    });
}

function setTeamState(round, team, state){
    database.ref(`teamStates/${round}/${team}`).set(state);
}

function initializeStates(){
    getTeamList((teams) => {
        getTeamStates((states) => {
            let updated = false;
            
            // Ensure all rounds exist
            for(let r=1; r<=4; r++){
                if(!states[r]) {
                    states[r] = {};
                    updated = true;
                }
                
                // Ensure all teams exist in each round
                teams.forEach(team => {
                    if(!states[r][team]) {
                        states[r][team] = "revoked";
                        updated = true;
                    }
                });
            }
            
            if(updated){
                database.ref('teamStates').set(states);
            }
            
            render();
        });
    });
}

// ==========================================
// TEAM MANAGEMENT
// ==========================================

function addTeam(){
    const input = document.getElementById("new-team-input");
    const teamName = input.value.trim().toUpperCase();
    
    if(!teamName){
        alert("Please enter a team name");
        return;
    }
    
    if(!/^[A-Z0-9_]+$/.test(teamName)){
        alert("Team name can only contain letters, numbers, and underscores");
        return;
    }
    
    getTeamList((teams) => {
        if(teams.includes(teamName)){
            alert("Team already exists");
            return;
        }
        
        if(teams.length >= 35){
            alert("Maximum 35 teams reached");
            return;
        }
        
        teams.push(teamName);
        setTeamList(teams);
        
        // Initialize states for new team
        for(let r=1; r<=4; r++){
            setTeamState(r, teamName, "revoked");
        }
        
        input.value = "";
        render();
    });
}

function removeTeam(teamName){
    if(!confirm(`Remove team ${teamName}? This will delete all their data.`)){
        return;
    }
    
    getTeamList((teams) => {
        const index = teams.indexOf(teamName);
        
        if(index > -1){
            teams.splice(index, 1);
            setTeamList(teams);
            
            // Remove from states
            for(let r=1; r<=4; r++){
                database.ref(`teamStates/${r}/${teamName}`).remove();
            }
            
            render();
        }
    });
}

// ==========================================
// STATE MANAGEMENT
// ==========================================

function cycle(round, team){
    getTeamStates((states) => {
        const cur = states[round][team] || "revoked";
        const next = STATES[(STATES.indexOf(cur)+1)%4];
        setTeamState(round, team, next);
        render();
    });
}

// ==========================================
// RENDER
// ==========================================

function render(){
    getTeamList((teams) => {
        getTeamStates((states) => {
            // Hide loading, show content
            document.getElementById("loading").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            
            // Render team list
            const teamListHTML = teams.map(team => 
                `<div class="team-tag">
                    ${team}
                    <span class="remove-team" onclick="removeTeam('${team}')">×</span>
                </div>`
            ).join('');
            document.getElementById("team-list").innerHTML = teamListHTML;
            
            // Render grid
            let html = "";
            
            teams.forEach(team => {
                html += `<tr>`;
                html += `<td>${team}</td>`;
                
                for(let r=1; r<=4; r++){
                    const state = states[r][team] || "revoked";
                    html += `
                        <td>
                            <div onclick="cycle(${r},'${team}')" class="btn">
                                <div class="state">${state}</div>
                            </div>
                        </td>
                    `;
                }
                
                html += `</tr>`;
            });
            
            document.getElementById("grid-body").innerHTML = html;
        });
    });
}

function logout(){
    sessionStorage.removeItem(ADMIN_SESSION_KEY);
    window.location.href = "rounds.html";
}

// ==========================================
// INITIALIZE
// ==========================================

// Initialize default teams if none exist
getTeamList((teams) => {
    if(teams.length === 0 || !teams){
        setTeamList(["ALPHA", "BETA", "GAMMA"]);
    }
    initializeStates();
});
</script>
</body>
</html>
